(()=>{"use strict";var t={913:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.config=void 0;const o=r(142),a=r(282);o.config(),e.config={auth:{token:a.env.AUTH_TOKEN||""},db:{path:a.env.DB_PATH||":memory:"},http:{port:+(a.env.HTTP_PORT||3e3)}},e.default=e.config},244:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BoardController=void 0;const o=r(758);class a{constructor(t,e){this.boardRepository=t,this.boardManager=e,this.index=async t=>{const e=+(t.query.page||0),r=await this.boardRepository.browse(e);t.body={items:r.map(this.convertModelToDto)}},this.show=async t=>{const e=String(t.params.slug||"").trim(),r=await this.boardRepository.readBySlug(e);if(null===r)throw new o.NotFoundError("slug");t.body={item:this.convertModelToDto(r)}},this.create=async t=>{const e=String(t.request.body.slug||"").trim(),r=String(t.request.body.title||"").trim(),a=await this.boardManager.createBoard(this.boardRepository,e,r);if(null===a)throw new o.NotFoundError("slug");t.status=201,t.set("Location",`/api/v1/boards/${a.id}`),t.body={item:this.convertModelToDto(a)}},this.update=async t=>{const e=String(t.params.slug||"").trim(),r=String(t.request.body.slug||"").trim(),a=String(t.request.body.title||"").trim(),n=await this.boardManager.updateBoard(this.boardRepository,e,r,a);if(null===n)throw new o.NotFoundError("slug");t.body={item:this.convertModelToDto(n)}},this.delete=async t=>{const e=String(t.params.slug||"").trim(),r=await this.boardManager.deleteBoard(this.boardRepository,e);if(null===r)throw new o.NotFoundError("slug");t.body={item:this.convertModelToDto(r)}}}convertModelToDto(t){return{slug:t.slug,title:t.title,created_at:t.createdAt.toISOString(),post_count:t.postCount}}}e.BoardController=a,e.default=a},758:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ConflictError=e.NotFoundError=e.NotAuthenticatedError=e.ValidationError=void 0;class r extends Error{constructor(t,e,r){super(r),this.field=t,this.error=e}}e.ValidationError=r;class o extends Error{}e.NotAuthenticatedError=o;class a extends Error{constructor(t,e){super(e),this.field=t}}e.NotFoundError=a;class n extends Error{constructor(t,e){super(e),this.field=t}}e.ConflictError=n},343:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.auth=void 0;const o=r(913),a=r(758);e.auth=function(){return async function(t,e){if(t.get("Authorization")!==`Bearer ${o.default.auth.token}`)throw new a.NotAuthenticatedError;await e()}}},697:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.errorHandler=void 0;const o=r(758);e.errorHandler=function(){return async function(t,e){try{await e()}catch(e){e instanceof o.ValidationError?(t.status=400,t.body={status:400,field:e.field,message:e.error}):e instanceof o.NotAuthenticatedError?(t.status=401,t.set("WWW-Authenticate","Bearer"),t.body={status:401,message:"not_authenticated"}):e instanceof o.NotFoundError?(t.status=404,t.body={status:404,field:e.field,message:e.message||"not_found"}):e instanceof o.ConflictError?(t.status=409,t.body={status:409,field:e.field,message:e.message||"conflict"}):(t.status=500,t.body={status:500,message:"internal_server_error"},console.error(e))}}}},482:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BoardManager=void 0;const o=r(758),a=r(812);class n{async createBoard(t,e,r){if(!e.length)throw new o.ValidationError("slug","required");if(e.length>a.default.MAX_SLUG_LENGTH)throw new o.ValidationError("slug","max-length");if(null===e.match(a.default.SLUG_PATTERN))throw new o.ValidationError("slug","pattern");if(!r.length)throw new o.ValidationError("title","required");if(e.length>a.default.MAX_TITLE_LENGTH)throw new o.ValidationError("title","max-length");if(-1!==a.default.RESERVED_NAMES.indexOf(e))throw new o.ConflictError("slug");if(null!==await t.readBySlug(e))throw new o.ConflictError("slug");const n=await t.add(e,r);if(null===n)throw new o.NotFoundError("slug");return n}async updateBoard(t,e,r,n){if(!r.length)throw new o.ValidationError("slug","required");if(r.length>a.default.MAX_SLUG_LENGTH)throw new o.ValidationError("slug","max-length");if(null===r.match(a.default.SLUG_PATTERN))throw new o.ValidationError("slug","pattern");if(!n.length)throw new o.ValidationError("title","required");if(r.length>a.default.MAX_TITLE_LENGTH)throw new o.ValidationError("title","max-length");if(-1!==a.default.RESERVED_NAMES.indexOf(r))throw new o.ConflictError("slug");let s=await t.readBySlug(e);if(null===s)throw new o.NotFoundError("slug");if(s=await t.edit(s.id,r,n),null===s)throw new o.NotFoundError("slug");return s}async deleteBoard(t,e){let r=await t.readBySlug(e);if(null===r)throw new o.NotFoundError("slug");if(r=await t.delete(r.id),null===r)throw new o.NotFoundError("slug");return r}}e.BoardManager=n,e.default=n},812:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Board=void 0;class r{constructor(t,e,r,o,a){this.id=t,this.slug=e,this.title=r,this.createdAt=o,this.postCount=a}}e.Board=r,r.MAX_SLUG_LENGTH=20,r.MAX_TITLE_LENGTH=100,r.SLUG_PATTERN=/^[0-9a-z_-]+$/,r.RESERVED_NAMES=["admin","api","settings","sse","ws"],e.default=r},59:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BoardRepository=void 0;const o=r(812);class a{constructor(t){this.db=t}browse(t=0){const e=`SELECT * FROM boards\n      ORDER BY post_count DESC, created_at DESC\n      LIMIT ${a.PER_PAGE} OFFSET ${Math.max(0,Math.floor(t))*a.PER_PAGE}`;return new Promise(((t,r)=>{this.db.all(e,((e,o)=>{if(null!==e)return r(e);t(o.map(this.convertDtoToModel))}))}))}read(t){return new Promise(((e,r)=>{this.db.get("SELECT * FROM boards\n      WHERE id = ?\n      ORDER BY id DESC\n      LIMIT 1",[t],((t,o)=>null!==t?r(t):void 0===o?e(null):void e(this.convertDtoToModel(o))))}))}readBySlug(t){return new Promise(((e,r)=>{this.db.get("SELECT * FROM boards\n      WHERE slug = ?\n      ORDER BY id DESC\n      LIMIT 1",[t],((t,o)=>null!==t?r(t):void 0===o?e(null):void e(this.convertDtoToModel(o))))}))}async edit(t,e,r){return null===await this.read(t)?null:new Promise(((o,a)=>{this.db.run("UPDATE boards\n      SET slug = ?, title = ?\n      WHERE id = ?",[e,r,t],(t=>{if(null!==t)return a(t);o(this.readBySlug(e))}))}))}add(t,e){return new Promise(((r,o)=>{this.db.run("INSERT INTO boards(slug, title, post_count, created_at)\n      VALUES (?, ?, 0, strftime('%s','now'))",[t,e],(e=>{if(null!==e)return o(e);r(this.readBySlug(t))}))}))}async delete(t){const e=await this.read(t);return null===e?null:new Promise(((r,o)=>{this.db.run("DELETE FROM boards\n      WHERE id = ?",[t],(t=>{if(null!==t)return o(t);r(e)}))}))}convertDtoToModel(t){return new o.default(t.id,t.slug,t.title,new Date(t.created_at*a.MS_IN_SECOND),t.post_count)}}e.BoardRepository=a,a.PER_PAGE=100,a.MS_IN_SECOND=1e3,e.default=a},320:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.setupDatabase=void 0,e.setupDatabase=function(t){t.serialize((()=>{t.run("CREATE TABLE IF NOT EXISTS boards (\n      id INTEGER NOT NULL PRIMARY KEY,\n      slug TEXT NOT NULL UNIQUE,\n      title TEXT NOT NULL,\n      post_count INTEGER NOT NULL,\n      created_at INTEGER NOT NULL\n    )"),t.run("CREATE INDEX IF NOT EXISTS boards_post_count_idx ON boards (post_count)"),t.run("CREATE INDEX IF NOT EXISTS boards_created_at_idx ON boards (created_at)")}))}},142:t=>{t.exports=require("dotenv")},406:t=>{t.exports=require("koa")},155:t=>{t.exports=require("koa-bodyparser")},752:t=>{t.exports=require("koa-router")},661:t=>{t.exports=require("sqlite3")},685:t=>{t.exports=require("http")},282:t=>{t.exports=require("process")}},e={};function r(o){var a=e[o];if(void 0!==a)return a.exports;var n=e[o]={exports:{}};return t[o](n,n.exports,r),n.exports}(()=>{const t=r(685),e=r(406),o=r(155),a=r(752),n=r(661),s=r(913),i=r(244),d=r(343),l=r(697),u=r(482),E=r(59),c=r(320),h=new n.Database(s.default.db.path,n.OPEN_CREATE|n.OPEN_READWRITE);(0,c.setupDatabase)(h);const f=new E.default(h),g=new u.default,w=new i.default(f,g),p=new a;p.get("/api/v1/boards",w.index),p.post("/api/v1/boards",w.create),p.get("/api/v1/boards/:slug",w.show),p.put("/api/v1/boards/:slug",(0,d.auth)(),w.update),p.delete("/api/v1/boards/:slug",(0,d.auth)(),w.delete);const _=new e;_.use((0,l.errorHandler)()),_.use(o()),_.use(p.routes()),_.use(p.allowedMethods()),t.createServer(_.callback()).listen(s.default.http.port)})()})();