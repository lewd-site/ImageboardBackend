(()=>{"use strict";var e={752:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createApp=void 0;const s=i(r(406)),a=i(r(155)),o=i(r(741)),n=i(r(922)),d=i(r(5)),l=i(r(552)),u=i(r(440)),p=i(r(97)),c=i(r(244)),h=i(r(250)),f=i(r(364)),E=i(r(718)),_=i(r(391)),m=r(343),g=r(697),b=i(r(482)),w=r(352),y=i(r(59)),T=i(r(547)),N=i(r(627)),I=i(r(451)),R=i(r(801)),x=r(7),O=r(414),v=i(r(550));t.createApp=function(e){const t=new y.default(e),r=new N.default(e),i=new R.default(e,r),S=new I.default(e,r),M=new T.default(e,r),A=new O.Thumbnailer,L=new b.default,F=new w.FileManager(A),D=new x.WakabaTripcodeGenerator,P=new E.default,C=new _.default,B=new c.default(t,L),k=new h.default(t,i,M,D,P,C,F),U=new f.default(t,i,S,M,D,P,C,F),G=new v.default(M,F),q=new o.default,H=(0,n.default)({dest:"tmp/"});q.get("/api/v1/boards/:slug/threads/:threadId/posts",H.fields([]),U.index),q.post("/api/v1/boards/:slug/threads/:threadId/posts",H.fields([{name:"files",maxCount:5}]),U.create),q.get("/api/v1/boards/:slug/threads/:threadId/posts/:id",H.fields([]),U.show),q.delete("/api/v1/boards/:slug/threads/:threadId/posts/:id",(0,m.auth)(),U.delete),q.get("/api/v1/boards/:slug/threads",H.fields([]),k.index),q.post("/api/v1/boards/:slug/threads",H.fields([{name:"files",maxCount:5}]),k.create),q.get("/api/v1/boards/:slug/threads/:threadId",H.fields([]),k.show),q.delete("/api/v1/boards/:slug/threads/:threadId",(0,m.auth)(),k.delete),q.get("/api/v1/boards/:slug/posts",H.fields([]),U.index),q.post("/api/v1/boards/:slug/posts",H.fields([{name:"files",maxCount:5}]),U.create),q.get("/api/v1/boards/:slug/posts/:id",H.fields([]),U.show),q.delete("/api/v1/boards/:slug/posts/:id",(0,m.auth)(),U.delete),q.get("/api/v1/boards",H.fields([]),B.index),q.post("/api/v1/boards",H.fields([]),B.create),q.get("/api/v1/boards/:slug",H.fields([]),B.show),q.put("/api/v1/boards/:slug",(0,m.auth)(),B.update),q.delete("/api/v1/boards/:slug",(0,m.auth)(),B.delete),q.get("/api/v1/threads/:threadId/posts",H.fields([]),U.index),q.post("/api/v1/threads/:threadId/posts",H.fields([{name:"files",maxCount:5}]),U.create),q.get("/api/v1/threads/:threadId/posts/:id",H.fields([]),U.show),q.delete("/api/v1/threads/:threadId/posts/:id",(0,m.auth)(),U.delete),q.get("/api/v1/threads",H.fields([]),k.index),q.post("/api/v1/threads",H.fields([{name:"files",maxCount:5}]),k.create),q.get("/api/v1/threads/:threadId",H.fields([]),k.show),q.delete("/api/v1/threads/:threadId",(0,m.auth)(),k.delete),q.get("/api/v1/posts",H.fields([]),U.index),q.post("/api/v1/posts",H.fields([{name:"files",maxCount:5}]),U.create),q.get("/api/v1/posts/:id",H.fields([]),U.show),q.delete("/api/v1/posts/:id",(0,m.auth)(),U.delete),q.get("/api/v1/thumbnails/:hash",H.fields([]),G.createThumbnail);const j=new s.default;return j.use(d.default.contentSecurityPolicy()),j.use(d.default.referrerPolicy()),j.use(d.default.noSniff()),j.use(d.default.dnsPrefetchControl()),j.use(d.default.hidePoweredBy()),j.use((0,l.default)()),j.use((0,u.default)()),j.use((0,p.default)("public",{maxAge:6048e5})),j.use((0,g.errorHandler)()),j.use((0,a.default)()),j.use(q.routes()),j.use(q.allowedMethods()),j}},913:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.config=void 0;const s=i(r(142)),a=r(282);s.default.config(),t.config={auth:{token:a.env.AUTH_TOKEN||""},db:{path:a.env.DB_PATH||":memory:"},http:{port:+(a.env.HTTP_PORT||3e3)},ffprobe:{path:a.env.FFPROBE_PATH||"ffprobe"},ffmpeg:{path:a.env.FFMPEG_PATH||"ffmpeg"}},t.default=t.config},244:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BoardController=void 0;const i=r(758),s=r(597);class a{constructor(e,t){this.boardRepository=e,this.boardManager=t,this.index=async e=>{const t=+(e.query.page||0),r=await this.boardRepository.browse(t);e.body={items:r.map(s.convertBoardModelToDto)}},this.show=async e=>{const t=String(e.params.slug||"").trim(),r=await this.boardRepository.readBySlug(t);if(null===r)throw new i.NotFoundError("slug");e.body={item:(0,s.convertBoardModelToDto)(r)}},this.create=async e=>{const t=String(e.request.body.slug||"").trim(),r=String(e.request.body.title||"").trim(),a=await this.boardManager.createBoard(this.boardRepository,t,r);if(null===a)throw new i.NotFoundError("slug");e.status=201,e.set("Location",`/api/v1/boards/${a.slug}`),e.body={item:(0,s.convertBoardModelToDto)(a)}},this.update=async e=>{const t=String(e.params.slug||"").trim(),r=String(e.request.body.slug||"").trim(),a=String(e.request.body.title||"").trim(),o=await this.boardManager.updateBoard(this.boardRepository,t,r,a);if(null===o)throw new i.NotFoundError("slug");e.body={item:(0,s.convertBoardModelToDto)(o)}},this.delete=async e=>{const t=String(e.params.slug||"").trim(),r=await this.boardManager.deleteBoard(this.boardRepository,t);if(null===r)throw new i.NotFoundError("slug");e.body={item:(0,s.convertBoardModelToDto)(r)}}}}t.BoardController=a,t.default=a},550:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FileController=void 0;const s=r(147),a=r(758),o=r(882),n=i(r(27));class d{constructor(e,t){this.fileRepository=e,this.fileManager=t,this.createThumbnail=async e=>{const t=String(e.params.hash||"").split(".");if(2!==t.length)throw new a.NotFoundError("hash");const[r,i]=t;if(!n.default.ALLOWED_THUMBNAIL_EXTENSIONS.includes(i))throw new a.NotFoundError("hash");const d=await this.fileRepository.readByHash(r);if(null===d)throw new a.NotFoundError("hash");const l=await this.fileManager.createThumbnail(d,i);e.set("Content-Type",(0,o.getMimeTypeByExtension)(i)||"application/octet-stream"),e.body=(0,s.createReadStream)(l)}}}t.FileController=d,t.default=d},364:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostController=void 0;const i=r(147),s=r(292),a=r(758),o=r(312),n=r(597);class d{constructor(e,t,r,d,l,u,p,c){this.boardRepository=e,this.threadRepository=t,this.postRepository=r,this.fileRepository=d,this.tripcodeGenerator=l,this.tokenizer=u,this.parser=p,this.fileManager=c,this.index=async e=>{const t=+(e.params.threadId||0);if(0!==t){const r=await this.threadRepository.read(t);if(null===r)throw new a.NotFoundError("threadId");const i=String(e.params.slug||"").trim();if(i.length){const e=await this.boardRepository.readBySlug(i);if(null===e||e.id!==r.board.id)throw new a.NotFoundError("slug")}const s=await this.postRepository.browseForThread(t);return await this.fileRepository.loadForPosts(s),e.body={items:s.map(n.convertPostModelToDto)}}const r=String(e.params.slug||"").trim();if(r.length&&null===await this.boardRepository.readBySlug(r))throw new a.NotFoundError("slug");const i=await this.postRepository.browse();await this.fileRepository.loadForPosts(i),e.body={items:i.map(n.convertPostModelToDto)}},this.show=async e=>{const t=+(e.params.id||0),r=await this.postRepository.read(t);if(null===r)throw new a.NotFoundError("id");const i=+(e.params.threadId||0);if(0!==i){const e=await this.threadRepository.read(i);if(null===e||e.id!==r.parentId)throw new a.NotFoundError("threadId")}const s=String(e.params.slug||"").trim();if(s.length){const e=await this.boardRepository.readBySlug(s);if(null===e||e.id!==r.board.id)throw new a.NotFoundError("slug")}await this.fileRepository.loadForPost(r),e.body={item:(0,n.convertPostModelToDto)(r)}},this.create=async e=>{const t=+(e.params.threadId||e.request.body.parentId||0),r=await this.threadRepository.read(t);if(null===r)throw new a.NotFoundError("threadId");const d=String(e.params.slug||"").trim();if(d.length){const e=await this.boardRepository.readBySlug(d);if(null===e||e.id!==r.board.id)throw new a.NotFoundError("slug")}const l=String(e.request.body.name||""),u=String(e.request.body.message||""),p=(void 0===e.files||Array.isArray(e.files)?[]:void 0!==e.files.files?e.files.files:[]).map(o.convertMulterFileToUploadedFile);try{const t=await this.fileManager.validateFiles(p),a=e.request.ip,o=await r.createPost(this.boardRepository,this.threadRepository,this.postRepository,this.fileRepository,this.tripcodeGenerator,this.tokenizer,this.parser,l,u,t,a);await this.fileRepository.loadForPost(o),await this.fileManager.moveFiles(t),e.status=201,e.set("Location",`/api/v1/boards/${r.board.slug}/threads/${r.id}/posts/${o.id}`),e.body={item:(0,n.convertPostModelToDto)(o)}}finally{await Promise.all(p.map((e=>{if((0,i.existsSync)(e.path))return(0,s.unlink)(e.path)})))}},this.delete=async e=>{const t=+(e.params.id||0),r=await this.postRepository.read(t);if(null===r)throw new a.NotFoundError("id");const i=+(e.params.threadId||r.parentId||0),s=await this.threadRepository.read(i);if(null===s||s.id!==r.parentId)throw new a.NotFoundError("threadId");const o=String(e.params.slug||"").trim();if(o.length){const e=await this.boardRepository.readBySlug(o);if(null===e||e.id!==r.board.id)throw new a.NotFoundError("slug")}await this.fileRepository.loadForPost(r),await s.deletePost(this.postRepository,t),e.body={item:(0,n.convertPostModelToDto)(r)}}}}t.PostController=d,t.default=d},250:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ThreadController=void 0;const i=r(147),s=r(292),a=r(758),o=r(312),n=r(597);class d{constructor(e,t,r,d,l,u,p){this.boardRepository=e,this.threadRepository=t,this.fileRepository=r,this.tripcodeGenerator=d,this.tokenizer=l,this.parser=u,this.fileManager=p,this.index=async e=>{const t=String(e.params.slug||"").trim();if(t.length){const r=await this.boardRepository.readBySlug(t);if(null===r)throw new a.NotFoundError("slug");const i=+(e.query.page||0),s=await this.threadRepository.browseForBoard(r.id,i);return await this.fileRepository.loadForPosts(s),e.body={items:s.map(n.convertThreadModelToDto)}}const r=+(e.query.page||0),i=await this.threadRepository.browse(r);await this.fileRepository.loadForPosts(i),e.body={items:i.map(n.convertThreadModelToDto)}},this.show=async e=>{const t=+(e.params.threadId||0),r=await this.threadRepository.read(t);if(null===r)throw new a.NotFoundError("threadId");const i=String(e.params.slug||"").trim();if(i.length){const e=await this.boardRepository.readBySlug(i);if(null===e||e.id!==r.board.id)throw new a.NotFoundError("slug")}await this.fileRepository.loadForPost(r),e.body={item:(0,n.convertThreadModelToDto)(r)}},this.create=async e=>{const t=String(e.params.slug||e.request.body.slug||"").trim(),r=await this.boardRepository.readBySlug(t);if(null===r)throw new a.NotFoundError("slug");const d=String(e.request.body.subject||""),l=String(e.request.body.name||""),u=String(e.request.body.message||""),p=(void 0===e.files||Array.isArray(e.files)?[]:void 0!==e.files.files?e.files.files:[]).map(o.convertMulterFileToUploadedFile);try{const t=await this.fileManager.validateFiles(p),a=e.request.ip,o=await r.createThread(this.boardRepository,this.threadRepository,this.fileRepository,this.tripcodeGenerator,this.tokenizer,this.parser,d,l,u,t,a);await this.fileRepository.loadForPost(o),await this.fileManager.moveFiles(t),e.status=201,e.set("Location",`/api/v1/boards/${r.slug}/threads/${o.id}`),e.body={item:(0,n.convertThreadModelToDto)(o)}}finally{await Promise.all(p.map((e=>{if((0,i.existsSync)(e.path))return(0,s.unlink)(e.path)})))}},this.delete=async e=>{const t=+(e.params.threadId||0),r=await this.threadRepository.read(t);if(null===r)throw new a.NotFoundError("threadId");const i=String(e.params.slug||r.board.slug||"").trim(),s=await this.boardRepository.readBySlug(i);if(null===s||s.id!==r.board.id)throw new a.NotFoundError("slug");await this.fileRepository.loadForPost(r),await s.deleteThread(this.threadRepository,t),e.body={item:(0,n.convertThreadModelToDto)(r)}}}}t.ThreadController=d,t.default=d},597:(e,t)=>{function r(e){return{hash:e.hash,name:e.name,extension:e.extension,path:`original/${e.hash}.${e.extension}`,type:e.type,size:+e.size,width:e.width?+e.width:null,height:e.height?+e.height:null,length:e.length?+e.length:null,created_at:e.createdAt.toISOString()}}Object.defineProperty(t,"__esModule",{value:!0}),t.convertFileModelToDto=t.convertPostModelToDto=t.convertThreadModelToDto=t.convertBoardModelToDto=void 0,t.convertBoardModelToDto=function(e){return{slug:e.slug,title:e.title,created_at:e.createdAt.toISOString(),post_count:+e.postCount}},t.convertThreadModelToDto=function(e){return{id:+e.id,slug:e.board.slug,subject:e.subject,name:e.name,tripcode:e.tripcode,message:e.message,message_parsed:e.parsedMessage,files:e.files.map(r),created_at:e.createdAt.toISOString(),bumped_at:e.bumpedAt.toISOString(),post_count:+e.postCount}},t.convertPostModelToDto=function(e){return{id:+e.id,slug:e.board.slug,parent_id:+e.parentId,name:e.name,tripcode:e.tripcode,message:e.message,message_parsed:e.parsedMessage,files:e.files.map(r),created_at:e.createdAt.toISOString()}},t.convertFileModelToDto=r},758:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ConflictError=t.NotFoundError=t.NotAuthenticatedError=t.ValidationError=void 0;class r extends Error{constructor(e,t,r){super(r),this.field=e,this.error=t}}t.ValidationError=r;class i extends Error{}t.NotAuthenticatedError=i;class s extends Error{constructor(e,t){super(t),this.field=e}}t.NotFoundError=s;class a extends Error{constructor(e,t){super(t),this.field=e}}t.ConflictError=a},882:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getMimeTypeByExtension=t.detectFileType=void 0;const i=r(292),s=[{signatures:[{position:0,buffer:Buffer.from([82,73,70,70])},{position:8,buffer:Buffer.from([87,69,66,80])}],ext:"webp",mime:"image/webp"},{signatures:[{position:0,buffer:Buffer.from([255,216,255,224,0,16,74,70,73,70,0,1])}],ext:"jpg",mime:"image/jpeg"},{signatures:[{position:0,buffer:Buffer.from([255,216,255,225])},{position:6,buffer:Buffer.from([69,120,105,102,0,0])}],ext:"jpg",mime:"image/jpeg"},{signatures:[{position:0,buffer:Buffer.from([255,216,255,226])}],ext:"jpg",mime:"image/jpeg"},{signatures:[{position:0,buffer:Buffer.from([255,216,255,227])}],ext:"jpg",mime:"image/jpeg"},{signatures:[{position:0,buffer:Buffer.from([255,216,255,238])}],ext:"jpg",mime:"image/jpeg"},{signatures:[{position:0,buffer:Buffer.from([255,216,255,219])}],ext:"jpg",mime:"image/jpeg"},{signatures:[{position:0,buffer:Buffer.from([137,80,78,71,13,10,26,10])}],ext:"png",mime:"image/png"},{signatures:[{position:0,buffer:Buffer.from([71,73,70,56,55,97])}],ext:"gif",mime:"image/gif"},{signatures:[{position:0,buffer:Buffer.from([71,73,70,56,57,97])}],ext:"gif",mime:"image/gif"},{signatures:[{position:0,buffer:Buffer.from([66,77])}],ext:"bmp",mime:"image/bmp"},{signatures:[{position:0,buffer:Buffer.from([26,69,223,163])}],ext:"webm",mime:"video/webm"},{signatures:[{position:4,buffer:Buffer.from([102,116,121,112,105,115,111,109])}],ext:"mp4",mime:"video/mp4"},{signatures:[{position:0,buffer:Buffer.from([255,251])}],ext:"mp3",mime:"audio/mpeg"},{signatures:[{position:0,buffer:Buffer.from([255,243])}],ext:"mp3",mime:"audio/mpeg"},{signatures:[{position:0,buffer:Buffer.from([255,242])}],ext:"mp3",mime:"audio/mpeg"},{signatures:[{position:0,buffer:Buffer.from([73,68,51])}],ext:"mp3",mime:"audio/mpeg"},{signatures:[{position:0,buffer:Buffer.from([102,76,97,67])}],ext:"flac",mime:"audio/x-flac"},{signatures:[{position:0,buffer:Buffer.from([82,73,70,70])},{position:8,buffer:Buffer.from([87,65,86,69])}],ext:"mp3",mime:"audio/vnd.wave"}];t.detectFileType=async function(e){const t=await(0,i.open)(e,"r"),{buffer:r}=await t.read({length:12});t.close();for(const e of s){let t=!0;for(const i of e.signatures)if(!r.slice(i.position,i.position+i.buffer.length).equals(i.buffer)){t=!1;break}if(t)return{extension:e.ext,mimeType:e.mime}}return null},t.getMimeTypeByExtension=function(e){for(const t of s)if(t.ext===e)return t.mime;return null}},607:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(r(685)),a=i(r(661)),o=r(752),n=i(r(913)),d=r(320),l=new a.default.Database(n.default.db.path,a.default.OPEN_CREATE|a.default.OPEN_READWRITE);(0,d.setupDatabase)(l);const u=(0,o.createApp)(l);s.default.createServer(u.callback()).listen(n.default.http.port)},391:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Parser=void 0;class r{parse(e){const t=this.getStyleSpans(e),i=e.filter((e=>-1!==r._textTokenTypes.indexOf(e.type))).map((e=>{let r;switch(e.type){case"text":default:r={type:"text",text:e.text};break;case"newline":r={type:"newline"};break;case"quote":r={type:"style",style:"quote",value:e.quote,children:[{type:"text",text:e.text}]};break;case"reflink":r={type:"reflink",postID:e.postID,threadID:e.threadID};break;case"link":r={type:"link",text:e.text,url:e.url,icon:e.icon}}const i=t.filter((t=>e.index>=t.startIndex&&e.index<=t.endIndex));for(let e=i.length-1;e>=0;e--){const t=i[e];r={type:"style",style:t.style,value:t.value,children:[r]}}return r}));return this.mergeNodes(i)}getStyleSpans(e){let t=[];const r=[];return e.forEach((e=>{switch(e.type){case"bb_start":r.push({type:"bb",startIndex:e.index,tag:e.tag,value:e.value});break;case"bb_end":for(let i=r.length-1;i>=0;i--){const s=r[i];let a;if("bb"===s.type&&s.tag===e.tag){switch(s.tag){case"b":a="bold";break;case"i":a="italic";break;case"u":a="underline";break;case"s":a="strike";break;case"sup":a="superscript";break;case"sub":a="subscript";break;case"spoiler":a="spoiler";break;case"code":a="code";break;case"color":a="color";break;case"size":a="size";break;default:throw new Error(`Unknown tag: ${s.tag}`)}t.push({startIndex:s.startIndex,endIndex:e.index,style:a,value:s.value}),r.splice(i,1);break}}break;case"wm_start":r.push({type:"wm",startIndex:e.index,text:e.text});break;case"wm_end":for(let i=r.length-1;i>=0;i--){const s=r[i];let a;if("wm"===s.type&&s.text===e.text){switch(s.text){case"**":a="bold";break;case"*":a="italic";break;case"~~":a="strike";break;case"%%":a="spoiler";break;default:throw console.log(s),new Error(`Unknown tag: ${s.text}`)}t.push({startIndex:s.startIndex,endIndex:e.index,style:a}),r.splice(i,1);break}}}})),t=this.fixOverlaps(t),t.sort(((e,t)=>e.startIndex===t.startIndex?e.endIndex-t.endIndex:e.startIndex-t.startIndex)),t}fixOverlaps(e){for(let t=0;t<e.length-1;t++)for(let r=t+1;r<e.length;r++){const i=e[t],s=e[r];i.startIndex<s.startIndex&&i.endIndex>s.startIndex&&i.endIndex<s.endIndex?(e[t]={...i,endIndex:s.startIndex},e.push({...i,startIndex:s.startIndex})):s.startIndex>s.startIndex&&s.startIndex<i.startIndex&&s.endIndex>s.endIndex&&(e[r]={...s,endIndex:i.endIndex},e.push({...s,startIndex:i.endIndex}))}return e}mergeNodes(e){for(let t=0;t<e.length-1;t++){const r=e[t],i=e[t+1];if("style"===r.type&&"style"===i.type&&r.style===i.style&&r.value===i.value){const{style:s,value:a}=r,o=this.mergeNodes([...r.children,...i.children]);e[t]={type:"style",style:s,value:a,children:o},e.splice(t+1,1),t--}else if("text"===r.type&&"text"===i.type){const s=r.text+i.text;e[t]={type:"text",text:s},e.splice(t+1,1),t--}}return e}}t.Parser=r,r._textTokenTypes=["text","newline","quote","reflink","link"],t.default=r},718:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Tokenizer=void 0;class r{tokenize(e){const t=(e=e.replace(r._carriageReturnRegExp,"")).split(r._tokenRegExp).filter((e=>e.length)),i=[];let s=[],a=0;return t.forEach((e=>{let t=null;if(null!==e.match(/^\n$/))s.push({type:"newline",index:a,text:e});else if(null!==(t=e.match(/^>>(\d+)$/))){const r=+t[1];s.push({type:"reflink",index:a,text:e,postID:r})}else if(null!==(t=e.match(/^>(.*?)$/))){const r=t[1];s.push({type:"quote",index:a,text:e,quote:r})}else if(null!==e.match(/^(\*\*|\*|%%|~~)$/)){const t=i.indexOf(e);-1===t?(i.push(e),s.push({type:"wm_start",index:a,text:e})):(i.splice(t,1),s.push({type:"wm_end",index:a,text:e}))}else if(null!==(t=e.match(/^\[([bius]|su[pb]|spoiler)]$/i))){const r=t[1];s.push({type:"bb_start",index:a,text:e,tag:r})}else if(null!==(t=e.match(/^\[(color)=(#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8}))]$/i))){const r=t[1],i=t[2];s.push({type:"bb_start",index:a,text:e,tag:r,value:i})}else if(null!==(t=e.match(/^\[(size)=([1-9]\d?)]$/i))){const r=t[1],i=t[2];s.push({type:"bb_start",index:a,text:e,tag:r,value:i})}else if(null!==(t=e.match(/^\[\/([bius]|su[pb]|spoiler|color|size)]$/i))){const r=t[1];s.push({type:"bb_end",index:a,text:e,tag:r})}else if(null!==(t=e.match(/^\[code]([\s\S]*?)\[\/code]$/i))){const e="code",r=t[1];s.push({type:"bb_start",index:a,text:"[code]",tag:e}),a++,s.push({type:"text",index:a,text:r}),a++,s.push({type:"bb_end",index:a,text:"[/code]",tag:e})}else if(null!==(t=e.match(new RegExp(`^(${r._urlPattern})$`,"i")))){const r=t[1];s.push({type:"link",index:a,text:e,url:r})}else s.push({type:"text",index:a,text:e});a++})),s=this.convertUnpairedTagsToText(s),this.mergeTokens(s)}convertUnpairedTagsToText(e){const t=[],r=[];return e.forEach(((i,s)=>{switch(i.type){case"bb_start":t.push({...i,index:s});break;case"bb_end":{let r=!1;for(let e=t.length-1;e>=0;e--)if(t[e].tag===i.tag){r=!0,t.splice(e,1);break}r||(e[s]={type:"text",index:s,text:i.text})}break;case"wm_start":r.push({...i,index:s});break;case"wm_end":{let t=!1;for(let e=r.length-1;e>=0;e--)if(r[e].text===i.text){t=!0,r.splice(e,1);break}t||(e[s]={type:"text",index:s,text:i.text})}}})),t.forEach((t=>{e[t.index]={type:"text",index:t.index,text:t.text}})),r.forEach((t=>{e[t.index]={type:"text",index:t.index,text:t.text}})),e}mergeTokens(e){for(let t=0;t<e.length-1;t++){const r=e[t],i=e[t+1];if("text"===r.type&&"text"===i.type){const s=r.text+i.text,{index:a}=r;e[t]={type:"text",index:a,text:s},e.splice(t+1,1),t--}}return e}}t.Tokenizer=r,r._urlPattern="https?:\\/\\/(?:[^?#@[\\]\\s]+@)?(?:[^.[\\]\\s-][^?#\\/[\\]\\s]*|\\[[0-9a-f:]+](?::\\d+)?)(?:\\/[^\\/?#[\\]\\s]*)*(?:\\?[^#[\\]\\s]+)?(?:#[^[\\]\\s]+)?",r._tokenPattern="(\\[code][\\s\\S]*?\\[\\/code]|\\[(?:[bius]|su[pb]|spoiler)]|\\[color=#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})]|\\[size=[1-9]\\d?]|\\[\\/(?:[bius]|su[pb]|spoiler|color|size)]|>>\\d+|^>.*?$|\\*\\*|\\*|%%|~~|\\n|"+r._urlPattern+")",r._carriageReturnRegExp=new RegExp("\r","g"),r._urlRegExp=new RegExp(r._urlPattern,"ig"),r._tokenRegExp=new RegExp(r._tokenPattern,"img"),t.default=r},343:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.auth=void 0;const s=i(r(913)),a=r(758);t.auth=function(){return async function(e,t){if(e.get("Authorization")!==`Bearer ${s.default.auth.token}`)throw new a.NotAuthenticatedError;await t()}}},697:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.errorHandler=void 0;const i=r(758);t.errorHandler=function(){return async function(e,t){try{await t()}catch(t){t instanceof i.ValidationError?(e.status=400,e.body={status:400,field:t.field,message:t.error}):t instanceof i.NotAuthenticatedError?(e.status=401,e.set("WWW-Authenticate","Bearer"),e.body={status:401,message:"not_authenticated"}):t instanceof i.NotFoundError?(e.status=404,e.body={status:404,field:t.field,message:t.message||"not_found"}):t instanceof i.ConflictError?(e.status=409,e.body={status:409,field:t.field,message:t.message||"conflict"}):(e.status=500,e.body={status:500,message:"internal_server_error"},console.error(t))}}}},482:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BoardManager=void 0;const s=r(758),a=i(r(812));class o{async createBoard(e,t,r){if(!t.length)throw new s.ValidationError("slug","required");if(t.length>a.default.MAX_SLUG_LENGTH)throw new s.ValidationError("slug","max-length");if(null===t.match(a.default.SLUG_PATTERN))throw new s.ValidationError("slug","pattern");if(!r.length)throw new s.ValidationError("title","required");if(t.length>a.default.MAX_TITLE_LENGTH)throw new s.ValidationError("title","max-length");if(-1!==a.default.RESERVED_NAMES.indexOf(t))throw new s.ConflictError("slug");if(null!==await e.readBySlug(t))throw new s.ConflictError("slug");const i=await e.add(t,r);if(null===i)throw new s.NotFoundError("slug");return i}async updateBoard(e,t,r,i){if(!r.length)throw new s.ValidationError("slug","required");if(r.length>a.default.MAX_SLUG_LENGTH)throw new s.ValidationError("slug","max-length");if(null===r.match(a.default.SLUG_PATTERN))throw new s.ValidationError("slug","pattern");if(!i.length)throw new s.ValidationError("title","required");if(r.length>a.default.MAX_TITLE_LENGTH)throw new s.ValidationError("title","max-length");if(-1!==a.default.RESERVED_NAMES.indexOf(r))throw new s.ConflictError("slug");let o=await e.readBySlug(t);if(null===o)throw new s.NotFoundError("slug");if(o=await e.edit(o.id,r,i),null===o)throw new s.NotFoundError("slug");return o}async deleteBoard(e,t){let r=await e.readBySlug(t);if(null===r)throw new s.NotFoundError("slug");if(r=await e.delete(r.id),null===r)throw new s.NotFoundError("slug");return r}}t.BoardManager=o,t.default=o},812:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Board=void 0;const s=r(758),a=i(r(624));class o{constructor(e,t,r,i,s){this.id=e,this.slug=t,this.title=r,this.createdAt=i,this.postCount=s}async createThread(e,t,r,i,o,n,d,l,u,p,c){if(!l.length)throw new s.ValidationError("name","required");if(l.length>a.default.MAX_NAME_LENGTH)throw new s.ValidationError("name","max-length");if(!u.length)throw new s.ValidationError("message","required");if(u.length>a.default.MAX_MESSAGE_LENGTH)throw new s.ValidationError("message","max-length");const h=i.createTripcode(l),f=o.tokenize(u),E=n.parse(f);let _=null;try{if(await t.begin(),_=await t.add(this.id,d,h.name,h.tripcode,u,E,c),null===_)throw new Error("Can't create thread");await e.incrementPostCount(this.id);for(const e of p){const t=await r.readOrAdd(e.hash,e.originalName,e.extension,e.mimeType,e.size,e.width,e.height,e.length,c);if(null===t)throw new Error("Can't create file");await r.addPostFileLink(_.id,t.id)}await t.commit()}catch(e){throw await t.rollback(),e}return _}async deleteThread(e,t){let r=await e.read(t);if(null===r||r.board.id!==this.id)throw new s.NotFoundError("threadId");if(r=await e.delete(t),null===r)throw new s.NotFoundError("threadId");return r}}t.Board=o,o.MAX_SLUG_LENGTH=20,o.MAX_TITLE_LENGTH=100,o.SLUG_PATTERN=/^[0-9a-z_-]+$/,o.RESERVED_NAMES=["admin","api","dashboard","original","settings","sse","thumbnails","ws"],t.default=o},352:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FileManager=void 0;const s=i(r(205)),a=r(147),o=r(292),n=i(r(957)),d=i(r(17)),l=i(r(913)),u=r(758),p=r(882),c=i(r(27)),h="public/original",f="public/thumbnails";t.FileManager=class{constructor(e){this.thumbnailer=e,this.validateFiles=e=>Promise.all(e.map(this.validateFile)),this.validateFile=async e=>{if(e.size>c.default.MAX_SIZE)throw new u.ValidationError("files","max-size");if("application/octet-stream"!==e.mimeType&&!c.default.ALLOWED_FILE_TYPES.includes(e.mimeType))throw new u.ValidationError("files","mimetype");const t=await(0,p.detectFileType)(e.path);if(null===t)throw new u.ValidationError("files","mimetype");const{extension:r,mimeType:i}=t;if(!c.default.ALLOWED_FILE_TYPES.includes(i))throw new u.ValidationError("files","mimetype");const{width:s,height:a,length:o}=await this.getFileDimensions(e.path);if(null!==s&&s>c.default.MAX_WIDTH)throw new u.ValidationError("file","max-width");if(null!==a&&a>c.default.MAX_HEIGHT)throw new u.ValidationError("file","max-height");return{...e,hash:await(0,n.default)(e.path),mimeType:i,extension:r,width:s,height:a,length:o}},this.moveFiles=async e=>{await Promise.all(e.map(this.moveFile))},this.moveFile=async e=>{(0,a.existsSync)(h)||await(0,o.mkdir)(h,{recursive:!0});const t=d.default.resolve(h,`${e.hash}.${e.extension}`);await(0,o.rename)(e.path,t)},this.createThumbnail=async(e,t)=>{let r=d.default.resolve(h,`${e.hash}.${e.extension}`);const i=d.default.resolve(f,`${e.hash}.${t}`);return(0,a.existsSync)(f)||await(0,o.mkdir)(f,{recursive:!0}),(0,a.existsSync)(i)||(null===e.width&&null===e.height&&(r=e.type.startsWith("audio/")?d.default.resolve(__dirname,"..","static","icons8-musical-notes-96.png"):d.default.resolve(__dirname,"..","static","icons8-cancel-96.png")),await this.thumbnailer.createThumbnail(r,i,250)),i}}async getFileDimensions(e){let t=null,r=null,i=null;const a=await(0,s.default)(e,l.default.ffprobe);for(const e of a.streams)void 0!==e.width&&(null===t||t<e.width)&&(t=+e.width),void 0!==e.height&&(null===r||r<e.height)&&(r=+e.height),void 0!==e.duration&&(null===i||i<e.duration)&&(i=+e.duration);return{width:t,height:r,length:i}}}},27:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.File=void 0;class r{constructor(e,t,r,i,s,a,o,n,d,l,u){this.id=e,this.hash=t,this.name=r,this.extension=i,this.type=s,this.size=a,this.width=o,this.height=n,this.length=d,this.ip=l,this.createdAt=u}}t.File=r,r.MAX_SIZE=104857600,r.MAX_WIDTH=8192,r.MAX_HEIGHT=8192,r.ALLOWED_FILE_TYPES=["image/webp","image/jpeg","image/png","image/gif","image/bmp","video/webm","video/mp4","audio/mpeg","audio/mp4","audio/x-flac","audio/vnd.wave"],r.ALLOWED_THUMBNAIL_EXTENSIONS=["webp","jpg","png"],t.default=r},894:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Post=void 0;class r{constructor(e,t,r,i,s,a,o,n,d){this.id=e,this.board=t,this.parentId=r,this.name=i,this.tripcode=s,this.message=a,this.parsedMessage=o,this.ip=n,this.createdAt=d,this.files=[]}}t.Post=r,r.MAX_NAME_LENGTH=40,r.MAX_MESSAGE_LENGTH=8e3,t.default=r},624:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Thread=void 0;const i=r(758);class s{constructor(e,t,r,i,s,a,o,n,d,l,u){this.id=e,this.board=t,this.subject=r,this.name=i,this.tripcode=s,this.message=a,this.parsedMessage=o,this.ip=n,this.postCount=d,this.createdAt=l,this.bumpedAt=u,this.files=[]}async createPost(e,t,r,a,o,n,d,l,u,p,c){if(!l.length)throw new i.ValidationError("name","required");if(l.length>s.MAX_NAME_LENGTH)throw new i.ValidationError("name","max-length");if(!u.length)throw new i.ValidationError("message","required");if(u.length>s.MAX_MESSAGE_LENGTH)throw new i.ValidationError("message","max-length");const h=o.createTripcode(l),f=n.tokenize(u),E=d.parse(f);let _=null;try{if(await r.begin(),_=await r.add(this.board.id,this.id,h.name,h.tripcode,u,E,c),null===_)throw new Error("Can't create post");await e.incrementPostCount(this.board.id),await t.incrementPostCount(this.id),this.postCount<s.BUMP_LIMIT&&await t.bumpThread(this.id);for(const e of p){const t=await a.readOrAdd(e.hash,e.originalName,e.extension,e.mimeType,e.size,e.width,e.height,e.length,c);if(null===t)throw new Error("Can't create file");await a.addPostFileLink(_.id,t.id)}await r.commit()}catch(e){throw await r.rollback(),e}return _}async deletePost(e,t){let r=await e.read(t);if(null===r||r.parentId!==this.id)throw new i.NotFoundError("id");if(r=await e.delete(t),null===r)throw new i.NotFoundError("id");return r}}t.Thread=s,s.MAX_NAME_LENGTH=40,s.MAX_MESSAGE_LENGTH=8e3,s.BUMP_LIMIT=500,t.default=s},312:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.convertMulterFileToUploadedFile=void 0,t.convertMulterFileToUploadedFile=function(e){return{originalName:e.originalname,mimeType:e.mimetype,size:e.size,path:e.path}}},59:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BoardRepository=void 0;const s=i(r(812)),a=i(r(251));class o extends a.default{async browse(e=0){const t=`SELECT * FROM boards\n      ORDER BY post_count DESC, id DESC\n      LIMIT ${o.PER_PAGE} OFFSET ${Math.max(0,Math.floor(e))*o.PER_PAGE}`,{rows:r}=await this.allAsync(t);return r.map(this.convertDtoToModel)}async read(e){const{row:t}=await this.getAsync("SELECT * FROM boards\n      WHERE id = ?\n      ORDER BY id DESC\n      LIMIT 1",[e]);return null===t?null:this.convertDtoToModel(t)}async readBySlug(e){const{row:t}=await this.getAsync("SELECT * FROM boards\n      WHERE slug = ?\n      ORDER BY id DESC\n      LIMIT 1",[e]);return null===t?null:this.convertDtoToModel(t)}async edit(e,t,r){return null===await this.read(e)?null:(await this.runAsync("UPDATE boards\n      SET slug = ?, title = ?\n      WHERE id = ?",[t,r,e]),this.readBySlug(t))}async incrementPostCount(e){return null===await this.read(e)?null:(await this.runAsync("UPDATE boards\n      SET post_count = post_count + 1\n      WHERE id = ?",[e]),await this.read(e))}async add(e,t){return await this.runAsync("INSERT INTO boards(slug, title, post_count, created_at)\n      VALUES (?, ?, 0, strftime('%s','now'))",[e,t]),this.readBySlug(e)}async delete(e){const t=await this.read(e);return null===t?null:(await this.runAsync("DELETE FROM boards\n      WHERE id = ?",[e]),t)}convertDtoToModel(e){return new s.default(+e.id,e.slug,e.title,new Date(e.created_at*o.MS_IN_SECOND),+e.post_count)}}t.BoardRepository=o,o.PER_PAGE=100,o.MS_IN_SECOND=1e3,t.default=o},547:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FileRepository=void 0;const s=i(r(27)),a=i(r(251));class o extends a.default{constructor(e,t){super(e),this.postAttributesRepository=t}async read(e){const{row:t}=await this.getAsync("SELECT f.*, i.ip FROM files f\n      INNER JOIN ips i ON i.id = f.ip_id\n      WHERE f.id = ?\n      ORDER BY f.id DESC\n      LIMIT 1",[e]);return null===t?null:this.convertDtoToModel(t)}async readByHash(e){const{row:t}=await this.getAsync("SELECT f.*, i.ip FROM files f\n      INNER JOIN ips i ON i.id = f.ip_id\n      WHERE f.hash = ?\n      ORDER BY f.id DESC\n      LIMIT 1",[e]);return null===t?null:this.convertDtoToModel(t)}async loadForPosts(e){if(!e.length)return;const t={};for(const r of e)t[r.id]=r;const r=`SELECT f.*, i.ip, pf.post_id FROM files f\n      INNER JOIN ips i ON i.id = f.ip_id\n      INNER JOIN posts_files pf ON pf.file_id = f.id\n      WHERE pf.post_id IN (${e.map((e=>e.id)).join(",")})\n      ORDER BY pf.post_id, f.id`,{rows:i}=await this.allAsync(r);for(const e of i){const r=this.convertDtoToModel(e);t[e.post_id].files.push(r)}}loadForPost(e){return this.loadForPosts([e])}async readOrAdd(e,t,r,i,s,a,o,n,d){const l=await this.readByHash(e);if(null!==l)return l;const u=await this.runAsync("INSERT INTO files (hash, name, extension, type, size, width, height, length, ip_id, created_at)\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, strftime('%s','now'))",[e,t,r,i,s,a,o,n,await this.postAttributesRepository.readOrAddIp(d)]);return this.read(u.lastID)}async addPostFileLink(e,t){await this.runAsync("INSERT INTO posts_files (post_id, file_id)\n      VALUES (?, ?)",[e,t])}async delete(e){const t=await this.read(e);return null===t?null:(await this.runAsync("DELETE FROM files WHERE id = ?",[e]),t)}convertDtoToModel(e){return new s.default(+e.id,e.hash,e.name,e.extension,e.type,e.size,e.width,e.height,e.length,e.ip,new Date(e.created_at*o.MS_IN_SECOND))}}t.FileRepository=o,o.MS_IN_SECOND=1e3,t.default=o},320:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.setupDatabase=void 0,t.setupDatabase=function(e){e.serialize((()=>{e.run("CREATE TABLE IF NOT EXISTS boards (\n      id INTEGER NOT NULL PRIMARY KEY,\n      slug TEXT NOT NULL UNIQUE,\n      title TEXT NOT NULL,\n      post_count INTEGER NOT NULL,\n      created_at INTEGER NOT NULL\n    )"),e.run("CREATE INDEX IF NOT EXISTS boards_post_count_idx ON boards (post_count)"),e.run("CREATE TABLE IF NOT EXISTS names (\n      id INTEGER NOT NULL PRIMARY KEY,\n      name TEXT NOT NULL UNIQUE\n    )"),e.run("CREATE TABLE IF NOT EXISTS tripcodes (\n      id INTEGER NOT NULL PRIMARY KEY,\n      tripcode TEXT NOT NULL UNIQUE\n    )"),e.run("CREATE TABLE IF NOT EXISTS ips (\n      id INTEGER NOT NULL PRIMARY KEY,\n      ip TEXT NOT NULL UNIQUE\n    )"),e.run("CREATE TABLE IF NOT EXISTS posts (\n      id INTEGER NOT NULL PRIMARY KEY,\n      board_id INTEGER NOT NULL REFERENCES boards (id) ON DELETE CASCADE,\n      parent_id INTEGER REFERENCES posts (id) ON DELETE CASCADE,\n      subject TEXT,\n      name_id INTEGER REFERENCES names (id) ON DELETE RESTRICT,\n      tripcode_id INTEGER REFERENCES tripcodes (id) ON DELETE RESTRICT,\n      message TEXT NOT NULL,\n      message_parsed TEXT NOT NULL,\n      ip_id INTEGER NOT NULL REFERENCES ips (id) ON DELETE RESTRICT,\n      created_at INTEGER NOT NULL,\n      bumped_at INTEGER,\n      post_count INTEGER\n    )"),e.run("CREATE INDEX IF NOT EXISTS posts_board_id_idx ON posts (board_id)"),e.run("CREATE INDEX IF NOT EXISTS posts_parent_id_idx ON posts (parent_id)"),e.run("CREATE INDEX IF NOT EXISTS posts_bumped_at_idx ON posts (bumped_at)"),e.run("CREATE TABLE IF NOT EXISTS files (\n      id INTEGER NOT NULL PRIMARY KEY,\n      hash TEXT NOT NULL UNIQUE,\n      name TEXT NOT NULL,\n      extension TEXT NOT NULL,\n      type TEXT NOT NULL,\n      size INTEGER NOT NULL,\n      width INTEGER,\n      height INTEGER,\n      length INTEGER,\n      ip_id INTEGER NOT NULL REFERENCES ips (id) ON DELETE RESTRICT,\n      created_at INTEGER NOT NULL\n    )"),e.run("CREATE INDEX IF NOT EXISTS files_hash_idx ON files (hash)"),e.run("CREATE TABLE IF NOT EXISTS posts_files (\n      id INTEGER NOT NULL PRIMARY KEY,\n      post_id INTEGER REFERENCES posts (id) ON DELETE CASCADE,\n      file_id INTEGER REFERENCES files (id) ON DELETE CASCADE\n    )"),e.run("CREATE INDEX IF NOT EXISTS posts_files_post_id_idx ON posts_files (post_id)")}))}},627:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PostAttributesRepository=void 0;const s=i(r(251));class a extends s.default{async readOrAddName(e){const t=await this.readName(e);return null===t?this.addName(e):t}async readName(e){const{row:t}=await this.getAsync("SELECT id FROM names WHERE name = ?",[e]);return null===t?null:t.id}async addName(e){return(await this.runAsync("INSERT INTO names (name) VALUES (?)",[e])).lastID}async readOrAddTripcode(e){const t=await this.readTripcode(e);return null===t?this.addTripcode(e):t}async readTripcode(e){const{row:t}=await this.getAsync("SELECT id FROM tripcodes WHERE tripcode = ?",[e]);return null===t?null:t.id}async addTripcode(e){return(await this.runAsync("INSERT INTO tripcodes (tripcode) VALUES (?)",[e])).lastID}async readOrAddIp(e){const t=await this.readIp(e);return null===t?this.addIp(e):t}async readIp(e){const{row:t}=await this.getAsync("SELECT id FROM ips WHERE ip = ?",[e]);return null===t?null:t.id}async addIp(e){return(await this.runAsync("INSERT INTO ips (ip) VALUES (?)",[e])).lastID}}t.PostAttributesRepository=a,t.default=a},451:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PostRepository=void 0;const s=i(r(812)),a=i(r(894)),o=i(r(251));class n extends o.default{constructor(e,t){super(e),this.postAttributesRepository=t}async browse(){const{rows:e}=await this.allAsync("SELECT\n        p.*,\n        b.id as board_id, b.slug as board_slug, b.title as board_title, b.created_at as board_created_at, b.post_count as board_post_count,\n        n.name,\n        t.tripcode,\n        i.ip\n      FROM posts p\n      INNER JOIN boards b ON b.id = p.board_id\n      LEFT JOIN names n ON n.id = p.name_id\n      LEFT JOIN tripcodes t ON t.id = p.tripcode_id\n      INNER JOIN ips i ON i.id = p.ip_id\n      ORDER BY p.id");return e.map(this.convertDtoToModel)}async browseForThread(e){const{rows:t}=await this.allAsync("SELECT\n        p.*,\n        b.id as board_id, b.slug as board_slug, b.title as board_title, b.created_at as board_created_at, b.post_count as board_post_count,\n        n.name,\n        t.tripcode,\n        i.ip\n      FROM posts p\n      INNER JOIN boards b ON b.id = p.board_id\n      LEFT JOIN names n ON n.id = p.name_id\n      LEFT JOIN tripcodes t ON t.id = p.tripcode_id\n      INNER JOIN ips i ON i.id = p.ip_id\n      WHERE p.parent_id = ? OR p.id = ?\n      ORDER BY p.id",[e,e]);return t.map(this.convertDtoToModel)}async read(e){const{row:t}=await this.getAsync("SELECT\n        p.*,\n        b.id as board_id, b.slug as board_slug, b.title as board_title, b.created_at as board_created_at, b.post_count as board_post_count,\n        n.name,\n        t.tripcode,\n        i.ip\n      FROM posts p\n      INNER JOIN boards b ON b.id = p.board_id\n      LEFT JOIN names n ON n.id = p.name_id\n      LEFT JOIN tripcodes t ON t.id = p.tripcode_id\n      INNER JOIN ips i ON i.id = p.ip_id\n      WHERE p.id = ?\n      ORDER BY p.id DESC\n      LIMIT 1",[e]);return null===t?null:this.convertDtoToModel(t)}async add(e,t,r,i,s,a,o){const n=await this.runAsync("INSERT INTO posts (board_id, parent_id, name_id, tripcode_id, message, message_parsed, ip_id, created_at, bumped_at)\n      VALUES (?, ?, ?, ?, ?, ?, ?, strftime('%s','now'), NULL)",[e,t,r.length?await this.postAttributesRepository.readOrAddName(r):null,i.length?await this.postAttributesRepository.readOrAddTripcode(i):null,s,JSON.stringify(a),await this.postAttributesRepository.readOrAddIp(o)]);return this.read(n.lastID)}async delete(e){const t=await this.read(e);return null===t?null:(await this.runAsync("DELETE FROM posts\n      WHERE id = ? AND parent_id IS NOT NULL",[e]),t)}convertDtoToModel(e){return new a.default(+e.id,new s.default(+e.board_id,e.board_slug,e.board_title,new Date(+e.board_created_at*n.MS_IN_SECOND),+e.board_post_count),+(e.parent_id||0),e.name,e.tripcode,e.message,JSON.parse(e.message_parsed),e.ip,new Date(e.created_at*n.MS_IN_SECOND))}}t.PostRepository=n,n.PER_PAGE=100,n.MS_IN_SECOND=1e3,t.default=n},251:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Repository=void 0;class r{constructor(e){this.db=e}async begin(){await this.runAsync("BEGIN")}async commit(){await this.runAsync("COMMIT")}async rollback(){await this.runAsync("ROLLBACK")}async runAsync(e,t=[]){return new Promise(((r,i)=>{this.db.run(e,t,(function(e){if(null!==e)return i(e);r(this)}))}))}async getAsync(e,t=[]){return new Promise(((r,i)=>{this.db.get(e,t,(function(e,t){return null!==e?i(e):void 0===t?r({statement:this,row:null}):void r({statement:this,row:t})}))}))}async allAsync(e,t=[]){return new Promise(((r,i)=>{this.db.all(e,t,(function(e,t){if(null!==e)return i(e);r({statement:this,rows:t})}))}))}}t.Repository=r,t.default=r},801:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ThreadRepository=void 0;const s=i(r(812)),a=i(r(624)),o=i(r(251));class n extends o.default{constructor(e,t){super(e),this.postAttributesRepository=t}async browse(e=0){const t=`SELECT\n        p.*,\n        b.id as board_id, b.slug as board_slug, b.title as board_title, b.created_at as board_created_at, b.post_count as board_post_count,\n        n.name,\n        t.tripcode,\n        i.ip\n      FROM posts p\n      INNER JOIN boards b ON b.id = p.board_id\n      LEFT JOIN names n ON n.id = p.name_id\n      LEFT JOIN tripcodes t ON t.id = p.tripcode_id\n      INNER JOIN ips i ON i.id = p.ip_id\n      WHERE p.parent_id IS NULL\n      ORDER BY p.bumped_at DESC, p.id DESC\n      LIMIT ${n.PER_PAGE} OFFSET ${Math.max(0,Math.floor(e))*n.PER_PAGE}`,{rows:r}=await this.allAsync(t);return r.map(this.convertDtoToModel)}async browseForBoard(e,t=0){const r=`SELECT\n        p.*,\n        b.id as board_id, b.slug as board_slug, b.title as board_title, b.created_at as board_created_at, b.post_count as board_post_count,\n        n.name,\n        t.tripcode,\n        i.ip\n      FROM posts p\n      INNER JOIN boards b ON b.id = p.board_id\n      LEFT JOIN names n ON n.id = p.name_id\n      LEFT JOIN tripcodes t ON t.id = p.tripcode_id\n      INNER JOIN ips i ON i.id = p.ip_id\n      WHERE p.board_id = ? AND p.parent_id IS NULL\n      ORDER BY p.bumped_at DESC, p.id DESC\n      LIMIT ${n.PER_PAGE} OFFSET ${Math.max(0,Math.floor(t))*n.PER_PAGE}`,{rows:i}=await this.allAsync(r,[e]);return i.map(this.convertDtoToModel)}async read(e){const{row:t}=await this.getAsync("SELECT\n        p.*,\n        b.id as board_id, b.slug as board_slug, b.title as board_title, b.created_at as board_created_at, b.post_count as board_post_count,\n        n.name,\n        t.tripcode,\n        i.ip\n      FROM posts p\n      INNER JOIN boards b ON b.id = p.board_id\n      LEFT JOIN names n ON n.id = p.name_id\n      LEFT JOIN tripcodes t ON t.id = p.tripcode_id\n      INNER JOIN ips i ON i.id = p.ip_id\n      WHERE p.id = ? AND p.parent_id IS NULL\n      ORDER BY p.id DESC\n      LIMIT 1",[e]);return null===t?null:this.convertDtoToModel(t)}async incrementPostCount(e){return null===await this.read(e)?null:(await this.runAsync("UPDATE posts\n      SET post_count = post_count + 1\n      WHERE id = ?",[e]),await this.read(e))}async bumpThread(e){return null===await this.read(e)?null:(await this.runAsync("UPDATE posts\n      SET bumped_at = strftime('%s','now')\n      WHERE id = ?",[e]),await this.read(e))}async add(e,t,r,i,s,a,o){const n=await this.runAsync("INSERT INTO posts(board_id, parent_id, subject, name_id, tripcode_id, message, message_parsed, ip_id, post_count, created_at, bumped_at)\n      VALUES (?, NULL, ?, ?, ?, ?, ?, ?, 1, strftime('%s','now'), strftime('%s','now'))",[e,t.length?t:null,r.length?await this.postAttributesRepository.readOrAddName(r):null,i.length?await this.postAttributesRepository.readOrAddTripcode(i):null,s,JSON.stringify(a),await this.postAttributesRepository.readOrAddIp(o)]);return this.read(n.lastID)}async delete(e){const t=await this.read(e);return null===t?null:(await this.runAsync("DELETE FROM posts\n      WHERE id = ? AND parent_id IS NULL",[e]),t)}convertDtoToModel(e){return new a.default(+e.id,new s.default(+e.board_id,e.board_slug,e.board_title,new Date(+e.board_created_at*n.MS_IN_SECOND),+e.board_post_count),e.subject,e.name,e.tripcode,e.message,JSON.parse(e.message_parsed),e.ip,+e.post_count,new Date(e.created_at*n.MS_IN_SECOND),new Date(e.bumped_at*n.MS_IN_SECOND))}}t.ThreadRepository=n,n.PER_PAGE=10,n.MS_IN_SECOND=1e3,t.default=n},414:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Thumbnailer=void 0;const s=r(81),a=r(147),o=i(r(913));t.Thumbnailer=class{createThumbnail(e,t,r){if(!(0,a.existsSync)(e))throw new Error(`File "${e}" not found`);const i=["-loglevel error","-hide_banner","-nostats","-y",`-i "${e.replace('"','\\"')}"`,"-ss 00:00:00",`-vf "scale='min(${r},iw)':'min(${r},ih):force_original_aspect_ratio=decrease'"`,"-vframes 1",t.endsWith(".webp")?"-quality 100":"",t.endsWith(".jpg")?"-qmin 1 -qscale:v 1":"",`"${t.replace('"','\\"')}"`],n=(0,s.spawn)(o.default.ffmpeg.path,i,{shell:!0});return new Promise(((e,t)=>{let r="";n.stderr.on("data",(e=>r+=e.toString())),n.stderr.on("error",t),n.on("exit",(e=>{0!==e&&t(new Error(`ffmpeg exited with code: ${r}, stderr: ${r}`))})),n.on("close",e)}))}}},7:function(e,t,r){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WakabaTripcodeGenerator=void 0;const s=i(r(379));class a{createTripcode(e){const t=e.indexOf("#");if(-1===t)return{name:e,tripcode:""};const r=e.substring(t+1);return{name:e=e.substring(0,t),tripcode:(0,s.default)(r)}}}t.WakabaTripcodeGenerator=a,t.default=a},922:e=>{e.exports=require("@koa/multer")},142:e=>{e.exports=require("dotenv")},205:e=>{e.exports=require("ffprobe")},406:e=>{e.exports=require("koa")},155:e=>{e.exports=require("koa-bodyparser")},552:e=>{e.exports=require("koa-conditional-get")},440:e=>{e.exports=require("koa-etag")},5:e=>{e.exports=require("koa-helmet")},741:e=>{e.exports=require("koa-router")},97:e=>{e.exports=require("koa-static")},957:e=>{e.exports=require("md5-file")},661:e=>{e.exports=require("sqlite3")},379:e=>{e.exports=require("tripcode")},81:e=>{e.exports=require("child_process")},147:e=>{e.exports=require("fs")},292:e=>{e.exports=require("fs/promises")},685:e=>{e.exports=require("http")},17:e=>{e.exports=require("path")},282:e=>{e.exports=require("process")}},t={};!function r(i){var s=t[i];if(void 0!==s)return s.exports;var a=t[i]={exports:{}};return e[i].call(a.exports,a,a.exports,r),a.exports}(607)})();